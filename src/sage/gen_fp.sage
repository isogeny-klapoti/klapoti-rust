"""
This file, given a prime p = 3 mod 4 computes all the following constants needed
for the macros fp_gen.rs and fp2_gen.rs

//      BITLEN (usize)            modulus length in bits
//      MODULUS ([u64; N])        modulus p (little-endian)
//      HALF_MODULUS ([u64; N])   (p + 1)/2 (little-endian)
//      R_VAL ([u64; N])          2^(64*N) mod p
//      DR_VAL ([u64; N])         2*R_VAL mod p = 2^(64*N+1) mod p
//      TR_VAL ([u64; N])         3*R_VAL mod p = 3*2^(64*N) mod p
//      QR_VAL ([u64; N])         4*R_VAL mod p = 2^(64*N+2) mod p
//      R2_VAL ([u64; N])         R_VAL^2 mod p = 2^(2*64*N) mod p
//      P0I (u64)                 -1/p mod 2^64
//      TFIXDIV_VAL               corrective factor for division
//      TDEC_VAL                  2^(64*(2*N-1)) mod p
//      SQRT_EH, SQRT_EL          encoding of (p + 1)/4
//      FOURTH_ROOT_EH, FOURTH_ROOT_EL          encoding of (p + 1)/8
//      P1 (u64)                  floor(p / 2^(BITLEN - 32))
//      P1DIV_M (u64)             1 + floor((2^32 - P1)*2^64 / P1)
//      NQR_RE_VAL                NQR_RE + i is a non-square in GF(p^2)
"""

# 254 bit prime
# f, ea, eb, ec = 35, 126, 76, 0

# 381 bit prime
# f, ea, eb, ec = 165, 198, 111, 0

# new prime
# f, ea, eb = 23, 148, 78
f, ea, eb, ec = 1, 131, 78, 0

# Define primes
p = f * 2**ea * 3**eb * 5**ec - 1

# FESTA-128 prime
# p = 124813370954946046625522215052328020445810037362111132960613286328441356722257752720010881927037475586399470137805050608043019087433283648739803958123964308223782110847178313188451195825370794537039688326247916639251700565349771267011273687997230352082398376708996664995018346239500252227115749220824758109724758742435933984445935095514141882211364143691731115285217804939575916379504639999

# Klapoti 64
p = 1243860333603982568026641440523014635142548663400435746517610765710004322303

# Klapoti 128
p = 82584400069028176969864875601918020463682940233361724162792604696040966687569903811249237681812751105439874935862118106234093567

# Klapoti 256
p = 346693286057780317918722983851464023027993557711204748896474215298754748552850689030086324176275029555880071714324990695516540585923637383820666204616304097346128761374347086485730058475154851941047152846013592390222143567118212391112697964815867687696259693714140561407

# Klapoti 512
# p = 16817108706960936047926250343229286165364990341381367811283310868820935595132760045264173360071734436962452806133974268664148211143175426529145662665005373084634528906709745342408486815448880285004001922067794609774238712489745132120678885224411134478776486050268946668789602410845866513375293532853950407027320322402414997263032829083981504396201531108899159641304979638840839572964949642695548216813886050284686242388986797442666560125246393609960082588564252826133453550579216736673746537938943

# Klapoti 768
# p = 33395060558743137027368454504087359109207798725160617707283511909435409148276414135214427465966285561662314837816800054200006473966344546824760846882458741414763678152082195180767233443977438203690887118082735382303478611064238643796768337520264988676353805457677047390442124083254891639725210964530401640226353609392634113421608298739060775799549376538257097147975941782552422655324158490503998562433330513333060308160227118879409222436901396388469091363000938373286542390624603820082512836033410175744145734108210038943519646240873562675299972451964455930804680435508286467772202603186653452703845756781869090891375594328685867683372043241421249159811272512709227633970041273297115634684087786086779604707555779720023522672639

# Klapoti 1024
# p = 739047374497571073067147030273896817592270991887381878791771086103505626324490396202533695982025452361033767627373251289515918234404033507052140064204466184213540084896545235671781891032680185221521116145028045668150584555064481005530563359642771278659507847021919939067727689726122686528747358314874328948686451715814597180300310063478673881633810090262924429481235385868735651462113643910274007461494719832664136052447645117405209489148744187388599395232034082136777302698710844384946741681803288237498033892414925548530114143206900958235941468713500620428804590464056645267492222816472134065778039447912552168480062749063708077399977007611994082339285434641748238701763861556120185572711207165911786823849981503114336741910622067601523541751045905950178020067153133625248328549843897879189262865663052173669282832024225711502466063763839884267046065964548174893030997252752999010318997979360117282581884199731288980798217573376172874253265751215237069012991

# Klapoti 1536
# p = 153558353861355903376739945149400159890759701873067072477310822811600057854483093088020633701350673908354868267690260288981806824265759153298523333903013837479283951891335260580981401304893251842428571050645352267353435000162652982843087061192927042613263780526306463378459427424092604673439811773621875070533661102056138192266787648882681870995049343165573740135817334723340226942592623507386302725226823417812078447284748225033727877111731485472258179607516239854873862921925788854502682693276647434652659158957801674402370942926451442698330024856275035162367621698475205525995942196216165874209304800805468438209975300541380438579825035991141063583598949990742554314298877829086079538939107066039663984457760671970514295926674815279302212606346259216014182082856043759856070511327989386619017982646262159718289094550906753334035054649308223769470048667596408387551932285791189266120514621764180262487812206693302956829904564635852805446988024538086033830972202938674009730940236637627897987288486773886938275552602692894351112315757437323546934739217652312946988034077543238179462403444867912371307484976495825904434422763657274086923404909521080755083985503237933997154581611596398375955035759047955616155328777729637817854485598127918381998804833476270985783346555916444583570009761746113467071920770902042057488227710627212075684437803980518152801031911816369772604035246476973156866587649539821970333810064460204736511

# Klapoti 2048
# p = 82014203224259545225085636426054254197905362219302006613283681888259410043933309642707178333110889969682612688866776236705410980110701176060896340811845644738440553570681151058933317386025455963706498561794761130643451160633612226767900018259794776037965781157015204889319904308661484877812530439413228724536462651214337108416854764950253938784639351508654486176367914580847325392045075900252135933903758700403287760915366855432656826160501180273550201641658479122748226565543583504734375333577770755142100109796804653952945405947482134282519773423424185120654103698827235921165553516626993535691948016108009587566611530553893557737424191168053782142615247618222400527127968856374563603464448471882280356928396882185147583785448116825576209521742769597661367350176329898729208925901916286727190363321222969776931032481374019967016688258952626894429926582050060706949749831723080168938653170025636958760284806237371299221904160132690836799108078270683977176825572051137484247421173124069147197606765857616913818325574940216370325077680814036598007335367356495332550195428791917617584408023512451425817522904090308759643095246561564068111670954236484558236595055880179164331339439530841677097878293586817250032019938460996079573651030040181656390472821908691383357692843376472781955941699987643645111501946819800911167441627847214758306446621963583698201374460441081273679578942711075392662536398151818368975385759792655416062645288724633540143909390462544218419881784352680723164116447596997375316223076353569266843988706731649943067943472391644095410324357124061820178392779222566102869736611308663455096043049878404388247450321380286032154318664901123479773417805837355886737148102179353402121568200453190428063784276725562953423895710512139271806582219915672134688986790373406897671339642770513811986858446210163461732371724733853210916158636113976217528210586897064562524159

def to_little_u64(n):
    res = []
    while n:
        tmp = n % 2**64
        res.append(hex(tmp))
        n >>= 64
    l = fmt_little_u64(res)
    return fmt_list(l)

def fmt_little_u64(res):
    out = []
    for r in res:
        num = r[2:]
        new_num = num.zfill(16)
        new_num = new_num.upper()
        new_num = "0x" + new_num
        out.append(new_num)
    return out

def fmt_list(l):
    l = str(l)
    l = l.replace("[", "")
    l = l.replace("]", "")
    l = l.replace("'", "")
    return l

def int_to_bytes(x):
    l = list(int(x).to_bytes((x.bit_length() + 7) // 8, byteorder="little"))
    return l


BITLEN = p.nbits()
N = ceil(BITLEN / 64)
MODULUS = to_little_u64(p)
P_PLUS_ONE = to_little_u64(p+1)
HALF_MODULUS = to_little_u64((p + 1) // 2)
R_VAL = to_little_u64(2**(64*N) % p)
MINUS_R_VAL = to_little_u64(-2**(64*N) % p)
DR_VAL = to_little_u64(2**(64*N+1) % p)
TR_VAL = to_little_u64(3*2**(64*N) % p)
QR_VAL = to_little_u64(2**(64*N + 2) % p)
R2_VAL = to_little_u64(2**(2*64*N) % p)
THREE_INV_VAL = to_little_u64((pow(3,-1,p) * 2**(64*N)) % p)
P0I = inverse_mod(-p, 2**64)
z = ea // 64
P_HAT = to_little_u64((p + 1) // 2**(z*64))

"""
let n1 = floor((2*BITLEN - 34) / 31)
let n2 = 2*BITLEN - 31*n1 - 2
TFIXDIV_VAL = 2^(33*n1 + 64 - n2 + 2*64*N) mod p
"""
n1 = floor((2*BITLEN - 34) // 31)
n2 = 2*BITLEN - 31*n1 - 2
TFIXDIV_VAL = 2**(33*n1 + 64 - n2 + 2*64*N) % p
TFIXDIV_VAL = to_little_u64(TFIXDIV_VAL)

TDEC_VAL = to_little_u64(2**(64*(2*N-1)) % p)

e = (p + 1)//4
SQRT_EL = BITLEN
while True:
    mod = 2**(5*SQRT_EL)
    if e % mod == 0:
        break
    SQRT_EL -= 1

SQRT_EH = e // 2^(5*SQRT_EL)
SQRT_EH = SQRT_EH.digits(2**5)

e = (p + 1)//8
FOURTH_ROOT_EL = BITLEN
while True:
    mod = 2**(5*FOURTH_ROOT_EL)
    if e % mod == 0:
        break
    FOURTH_ROOT_EL -= 1

FOURTH_ROOT_EH = e // 2^(5*FOURTH_ROOT_EL)
FOURTH_ROOT_EH = FOURTH_ROOT_EH.digits(2**5)

P1 = floor(p // 2**(BITLEN - 32))
P1DIV_M = 1 + ((2**32 - P1)*2**64 // P1)


F.<i> = GF(p**2, modulus=[1,0,1])
while True:
    NQR_RE_VAL = randint(0, p)
    if not F([NQR_RE_VAL, 1]).is_square():
        break
        
assert not F([NQR_RE_VAL, 1]).is_square()
NQR_RE_VAL = to_little_u64(2**(64*N) * NQR_RE_VAL % p)

P1_N_BITLEN = (2**ea).nbits()
P1_N = int_to_bytes(2**ea)
P1_B = ea;

P1_C_BITLEN = (3**eb).nbits()
P1_C = int_to_bytes(3**eb)
P1_C_EXP = eb;

P1_D_BITLEN = (3**ec).nbits()
P1_D = int_to_bytes(3**ec)
P1_D_EXP = ec;

P1_DIV_N_BITLEN = ((p+1) // 2**ea).nbits()
P1_DIV_N = int_to_bytes((p+1) // 2**ea)
P1_DIV_C_BITLEN = ((p+1) // 3**eb).nbits()
P1_DIV_C = int_to_bytes((p+1) // 3**eb)

P1_DIV_D_BITLEN = ((p+1) // 3**ec).nbits()
P1_DIV_D = int_to_bytes((p+1) // 3**ec)

P1_F = f

str = f"""
pub mod Fp{BITLEN} {{
    const N: usize = {N};
    const BITLEN: usize = {BITLEN};
    const MODULUS: [u64; N] = [
        {MODULUS}
    ];
    const HALF_MODULUS: [u64; N] = [
        {HALF_MODULUS}
    ];
    const R_VAL: [u64; N] = [
        {R_VAL}
    ];
    const MINUS_R_VAL: [u64; N] = [
        {MINUS_R_VAL}
    ];
    const DR_VAL: [u64; N] = [
        {DR_VAL}
    ];
    const TR_VAL: [u64; N] = [
        {TR_VAL}
    ];
    const QR_VAL: [u64; N] = [
        {QR_VAL}
    ];
    const R2_VAL: [u64; N] = [
        {R2_VAL}
    ];
    const THREE_INV_VAL: [u64; N] = [
        {THREE_INV_VAL}
    ];
    const P0I: u64 = {P0I};
    const TFIXDIV_VAL: [u64; N] = [
        {TFIXDIV_VAL}
    ];
    const TDEC_VAL: [u64; N] = [
        {TDEC_VAL}
    ];
    const WIN_LEN: usize = 5;
    const SQRT_EH: [u8; {len(SQRT_EH)}] = [
        {str(SQRT_EH).replace('[', '').replace(']', '')}
    ];
    const SQRT_EL: usize = {SQRT_EL};
    const FOURTH_ROOT_EH: [u8; {len(FOURTH_ROOT_EH)}] = [
        {str(FOURTH_ROOT_EH).replace('[', '').replace(']', '')}
    ];
    const FOURTH_ROOT_EL: usize = {FOURTH_ROOT_EL};
    const P1: u64 = {P1};
    const P1DIV_M: u64 = {P1DIV_M};

    crate::finitefield::fp_gen::define_fp_core!{{}}

    #[cfg(test)]
    mod tests {{
        crate::finitefield::fp_gen::define_fp_tests!{{}}
    }}
}}

pub mod Fp{BITLEN}Ext {{
    use super::Fp{BITLEN}::Fp;
    const NQR_RE: Fp = Fp::new([
        {NQR_RE_VAL}
    ]);

    const P1_N_BITLEN: usize = {P1_N_BITLEN};
    const P1_N: [u8; {len(P1_N)}] = [
        {fmt_list(P1_N)}
    ];
    const P1_B: usize = {P1_B};

    const P1_C_BITLEN: usize = {P1_C_BITLEN};
    const P1_C: [u8; {len(P1_C)}] = [
        {fmt_list(P1_C)}
    ];
    const P1_C_EXP: usize = {P1_C_EXP};
    const P1_F: u64 = {P1_F};

    const P1_DIV_N_BITLEN: usize = {P1_DIV_N_BITLEN};
    const P1_DIV_N: [u8; {len(P1_DIV_N)}] = [
        {fmt_list(P1_DIV_N)}
    ];

    const P1_DIV_C_BITLEN: usize = {P1_DIV_C_BITLEN};
    const P1_DIV_C: [u8; {len(P1_DIV_C)}] = [
        {fmt_list(P1_DIV_C)}
    ];

    crate::finitefield::fp2_gen::define_fp2_core! {{}}
    #[cfg(test)]
    mod tests {{
        crate::finitefield::fp2_gen::define_fp2_tests! {{}}
    }}
}}
"""

print(str)
